<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="NOTC">
    <meta name="author" content="MingYuan">
	<meta name="generator" content="Notepad++">
    <link rel="icon" href="img/logo.png">

<title>出售</title>
           
    <link rel="stylesheet" href="css/bootstrap.min.css">                                      
    <link rel="stylesheet" href="css/magnific-popup.css">                                     
    <link rel="stylesheet" href="css/templatemo-style.css">   
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.3.7/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="static/css/style.css?_=1.0.5">
    <link rel="stylesheet" href="editor.md/css/editormd.min.css" />
    <link rel="stylesheet" href="editor.md/css/editormd.preview.min.css" />
    <link href="css/airdrop.css" rel="stylesheet">
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/icons/icomoon/styles.css" rel="stylesheet" type="text/css">
    <link href="css/core.css" rel="stylesheet" type="text/css">
    <link href="css/components.css" rel="stylesheet" type="text/css">
    <link href="css/colors.css" rel="stylesheet" type="text/css">
    <link href="css/summernote.css" rel="stylesheet" type="text/css">
    <link href="css/owl.carousel.min.css" rel="stylesheet" type="text/css">
    <link href="css/owl.theme.default.min.css" rel="stylesheet" type="text/css">

                                   
    <script type="text/javascript" src="./jquery-3.3.1.min.js"></script> 
    <script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.2.6/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-router@3.0.1/dist/vue-router.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-ui@2.3.7/lib/index.js"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/nebPay.js"></script>
    <script src="js/nebulas.js"></script>
    <script src="js/nebConfig.js"></script>
    <script src="js/mustache.min.js"></script>
    <script src="js/buyConfig.js"></script>
    <script src="js/bootstrap.min2.js"></script>
    <script src="js/getWallectInfo.js?_=201805241200"></script>

  </head> 
  
    
   
<body id="top" class="page-2">

<div class="tm-navbar-container tm-navbar-container-dark">
    <nav class="navbar navbar-full navbar-fixed-top bg-inverse">
	    <button class="navbar-toggler hidden-md-up" type="button" data-toggle="collapse" data-target="#tmNavbar">
			&#9776;
		    </button>
		        <div class="collapse navbar-toggleable-sm" id="tmNavbar">
			        <ul class="nav navbar-nav">
					<li class="nav-item">
						<a class="nav-link" href="index.html">首页</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" >出售</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="buyadvertising.html">发布购买广告</a>
					</li>
					<li class="nav-item">
						<a class="nav-link external" href="interpretation.html">使用教程</a>
					</li>
					<li class="nav-item">
						<a class="nav-link external" href="lianxi.html">联系我们</a>
					</li>
					<li id="app" class="nav-item">
					    <a class="nav-link" >账户信息:{{balance}} NAS</a>
					</li>
					<li class="nav-item">
					    <input id="search_buy" class="form-control" placeholder="价格、数量、地址皆可查询" value="" name="search_car" style="margin-top: 15px" >
                        </li>
					<li class="nav-item">
					    <a class="nav-link" id="search" >搜索</a>
					</li>					
				</ul>
			</div>
	    </div>  
    </div>
 
   
    <section class="referrer-section" id="airdrop44" style="margin-top: 50px">
	  <div class="container">
        <div class="card-deck mb-3 text-center">
          <div class="card mb-4 box-shadow">
			<div class="card-body">
              <div class="card-body">
			    <a class="btn btn-default btn-lg tm-gray-btn" href="transactionfailure.html" style="margin-left: 10px">未成交</a>
				<a class="btn btn-default btn-lg tm-blue-btn" href="transactionsuccess.html" style="margin-left: 10px">已成交</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
	  
	  <section class="referrer-section"  style="margin-top: 10px"> 
	    <div class="container">
          <div class="card-deck mb-3 text-center">
            <div class="card mb-4 box-shadow">  
		       <div class="card-body" id=aloneSearch>
			   </div>
			</div>
		  </div>
        </div>
      </section>
	
	  <section class="referrer-section"  style="margin-top: 10px"> 
	    <div class="container">
          <div class="card-deck mb-3 text-center">
            <div class="card mb-4 box-shadow">  
	          <div class="row">
		        <div class="tm-section" id="buys">		
				</div>        
	          </div>
            </div>
          </div>
        </div>
      </section>

    <script>
      "use strict";
      var nebulas = require("nebulas");
      var Account = nebulas.Account;
      var neb = new nebulas.Neb();
      neb.setRequest(new nebulas.HttpRequest(rpcURL));

      var from = Account.NewAccount().getAddressString();
      var length = 0;
      var value = "0";
      var nonce = "0";
      var gas_price = "1000000";
      var gas_limit = "2000000";
      var callFunction = "length";
      var callArgs = ""; 
      var contract = {
        "function": callFunction,
        "args": callArgs
      };

      neb.api.call(from, dappcontractAddress, value, nonce, gas_price, gas_limit, contract).then(function (resp) {
        if(resp.result > 0){
          length = resp.result;
          for(var i = 0; i < resp.result; i++){
		      if(transactionfailure.includes(i)) continue;
			  if(transactionsuccess.includes(i)) continue;
		  if(transactionhide.includes(i)) continue;
            callFunction = "index";
            callArgs = "[" + i + "]"; 
            contract = {
              "function": callFunction,
              "args": callArgs
            };
            neb.api.call(from, dappcontractAddress, value, nonce, gas_price, gas_limit, contract).then(function (resp){
              addTransaction(resp);
              });
          }
        } 
      });
	  	 
      function addTransaction(resp){
          var result = resp.result; 
          try{
            result = JSON.parse(result);
          }catch (err){
          }
            var skeleton;
            var data;			
               skeleton='<div class="col-md-4 margin-bottom-sm-3"><div class="tm-3-col-box"><div class="tm-description-box" id=buys><h2 class="card-title pricing-card-title"><br><a>第{{buyIndex}}号广告单信息</a><br></h2><h5 class="card-title pricing-card-title"><br><a>收购价格：{{buyPrice}}CNY</a><br><a>收购数量：{{buyQuantity}}NAS</a><br><a>联系方式及支付方式需点击确认出售方可看见</a><br><a>接收地址：{{buyer}}</a><br></h5><button type="button" class="btn btn-lg btn-block  btn-default tm-normal-btn tm-green-btn" id="buyss{{buyIndex}}" onclick="receive({{buyIndex}})" value="{{eligible}}">确认出售</button></div></div></div></div></div>';              			            
               data = { buyPrice: result.buyPrice, buyQuantity: result.buyQuantity, contactWay: result.contactWay, paymentAccount: result.paymentAccount, buyer: result.buyer, buyIndex: result.index};           
			 
            var html = Mustache.to_html(skeleton, data);
            $("#buys").append(html);                
      }   
	  		
	  $("#search").click(function () {
        if (!$("#search_buy").val()) {
            $('#checkSearch').modal('show');
            return;
        }
        $('#aloneSearch').text("");
        var from = dappcontractAddress
        var value = "0";
        var nonce = "0"
        var gas_price = "1000000"
        var gas_limit = "2000000"
        var callFunction = "give";
        var callArgs = "[\"" + $("#search_buy").val() + "\"]";
        console.log(callArgs);
        var contract = {
            "function": callFunction,
            "args": callArgs
        }

        neb.api.call(from, dappcontractAddress, value, nonce, gas_price, gas_limit, contract).then(function (resp) {
            var result = resp.result;           
            if (result === 'null') {			
                var skeleto;
                var dat;
			    skeleto='<h2 class="card-title pricing-card-title"><br><a>搜索结果:无</a><br></h2><h5 class="card-title pricing-card-title"><br><a>建议你更换搜索词！<br>你可以搜索价格、数量、地址等！<br>当然你也可以不接受本程序的建议，你高兴就好！但是你搜索出来算你牛！</a><br></h5>';              			            
                dat = { buyPrice: result.buyPrice, buyQuantity: result.buyQuantity, totalSupply: result.totalSupply, buyerNum: result.buyerNum, buyerBonus: result.buyerBonus, referrerNum: result.referrerNum, buyer: result.buyer, buyIndex: result.index, eligible: 1};            
                var html = Mustache.to_html(skeleto, dat);
                $("#aloneSearch").append(html);
            }		 
            result = JSON.parse(result);			
			var skeleton;
            var data;
			for(var i = 0; i < 100; i++){
			  if(transactionfailure.includes(i)) continue;
			  if(transactionsuccess.includes(i)) continue;
			  if( i == result.index){
			 skeleton='<h2 class="card-title pricing-card-title"><br><a>搜索结果</a><br></h2><h3 class="card-title pricing-card-title"><br><a>第{{buyIndex}}号广告单信息</a><br></h3><h5 class="card-title pricing-card-title"><br><a>收购价格：{{buyPrice}}CNY</a><br><a>收购数量：{{buyQuantity}}NAS</a><br><a>联系方式及支付方式需点击确认出售方可看见</a><br><a>接收地址：{{buyer}}</a><br></h5><button type="button" class="btn btn-default tm-normal-btn tm-green-btn" id="buy{{buyIndex}}" onclick="receive({{buyIndex}})" value="{{eligible}}">确认出售</button>';              			            
             data = { buyPrice: result.buyPrice, buyQuantity: result.buyQuantity, contactWay: result.contactWay, paymentAccount: result.paymentAccount, buyer: result.buyer, buyIndex: result.index};           			
            var html = Mustache.to_html(skeleton, data);
            $("#aloneSearch").append(html);		
                  }			
			}
            }).catch(function (err) {
            console.log("error :" + err.message);
        })
    })
	
	  
	  var NebPay = require("nebpay");    
      var nebPay = new NebPay();
      var serialNumber;

      function receive(index){
        if(checkNASWallet()){		
	  var from = dappcontractAddress
      var length = 0;
      var value = "0";
      var nonce = "0";
      var gas_price = "1000000";
      var gas_limit = "2000000";
      var callFunction = "give";
      var callArgs = "[\"" + index + "\"]";
      var contract = {
        "function": callFunction,
        "args": callArgs
      };

      neb.api.call(from, dappcontractAddress, value, nonce, gas_price, gas_limit, contract).then(function (resp) {        
		    var result = resp.result;
            result = JSON.parse(result);	
                    if(result.buyQuantity > app.balance){
					   $("#checkBalance").modal('show');
					}else{
					   $("#affirmSale").modal('show');
					   $("#OKSale").click(function () {
					   $("#affirmSale").modal('hide');
					   var skeleton;
                       var data;
					   skeleton='<h3 class="card-title pricing-card-title"><br><a>第{{buyIndex}}号广告单信息</a><br></h3><h5 class="card-title pricing-card-title"><br><a>收购价格：{{buyPrice}}CNY</a><br><a>收购数量：{{buyQuantity}}NAS</a><br><a>联系方式：{{baymentAccount}} </a><br><a>接收地址：n1YgWn8bWrZiUBnkdcou16znraeXw5psi4d</a><br></h5>';              			                 			            
                       data = { buyPrice: result.buyPrice, buyQuantity: result.buyQuantity, contactWay: result.contactWay, paymentAccount: result.paymentAccount, buyer: result.buyer, buyIndex: result.index};           			
                       var html = Mustache.to_html(skeleton, data);
					   $("#affirm").modal('show');
                       $("#Salexinxi").append(html);	
                        })
					   }				   
			 })
		   }
		} 
		
      
                
					   
	  
	  
      function getTransactionReceipt(hash, callback){
        $.post(rpcURL + '/v1/user/getTransactionReceipt', JSON.stringify({
          "hash": hash
        }), function (resp) {
          callback(resp)
        })
      }

      function recheckTransactionReceipt(hash, cb) {
        var task = setInterval(function () {
          getTransactionReceipt(hash, function (resp) {
            var status = resp.result.status;
            if(status == 1){
              clearInterval(task);
              cb();
            }
          })
        }, 1000);
      }
	  
	  function checkNASWallet(){
        if (typeof (webExtensionWallet) === "undefined") {
          $(document).ready(function(){
            $("#noWallet").modal('show');
          });
          return false;
        }
        return true;
      }	 
    </script>   
  
  <div id="checkSearch" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">友情提示！</h4>
        </div>
        <div class="modal-body">
          <p>搜索内容不能为空！</p>
        </div>
        <div class="modal-footer"  style="padding-top: 10px">
          <br>
          <button type="button" class="btn btn-default" data-dismiss="modal" >关闭</button>
         </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
  
  <div id="affirmSale" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">友情提示！</h4>
        </div>
        <div class="modal-body">
          <p>当你点击坚定出售后,会弹出对方的联系方式。平台只做信息对接，如需购买请与收购方联系。</p>
        </div>
        <div class="modal-footer"  style="padding-top: 10px">
          <br>
          <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
         <a class="btn btn-primary" id="OKSale">坚定出售</a>
         </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
  
  <div id="checkBalance" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">友情提示！</h4>
        </div>
        <div class="modal-body">
          <p>很抱歉，你的余额不足！无法出售！</p>
        </div>
        <div class="modal-footer"  style="padding-top: 10px">
          <br>
          <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
  
  <div id="affirm" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">收购方信息！</h4>
        </div>
        <div class="modal-body" id="Salexinxi" style="font-style:center">
		
        </div>
        <div class="modal-footer"  style="padding-top: 10px">
          <br>
          <a class="btn btn-default" href="salexinxi.html">填写出售信息</a>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
  
  <div id="noWallet" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">友情提示！</h4>
        </div>
        <div class="modal-body">
          <p>你没有安装星云钱包，请使用谷歌浏览器安装星云钱包插件： <a href="https://github.com/nebulasotc/nasqianbao" target="_blank">钱包链接</a></p>
        </div>
        <div class="modal-footer"  style="padding-top: 10px">
          <br>
          <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
 
      <footer class="pt-4 my-md-5 pt-md-5 border-top">
        <div class="row">
          <div class="col-6 col-md">
            <h5>友情链接</h5>
            <ul class="list-unstyled text-small">
              <li><a class="text-muted" href="https://nebulas.io" target="_blank">星云官网</a></li>
              <li><a class="text-muted" href="https://explorer.nebulas.io" target="_blank">星云区块浏览器</a></li>
              <li><a class="text-muted" href="https://github.com/ChengOrangeJu/WebExtensionWallet" target="_blank">星云钱包插件</a></li>
              <li><a class="text-muted" href="https://incentive.nebulas.io/cn/signup.html?invite=QIdur" target="_blank">我也要开发</a></li>
			  <li><a class="text-muted" href="https://blog.csdn.net/lc326514244/article/details/80347136" target="_blank">最全开发教程</a></li>
              <li><a class="text-muted" href="https://blog.csdn.net/wingichoy/article/details/80291665" target="_blank">真正零门槛入门</a></li>
            </ul>
          </div>
          <div class="col-6 col-md">
            <h5>其他优质星云DAPP链接</h5>
            <ul class="list-unstyled text-small">
			<li><a class="text-muted" href="https://bbs.forfunapp.com/" target="_blank">链社区-基于星云链的微论坛</a></li>
			<li><a class="text-muted" href="http://nebulas.cool" target="_blank">星云链DApp商店</a></li>
			<li><a class="text-muted" href="http://cellevo.net/" target="_blank">细胞进化</a></li>
			<li><a class="text-muted" href="http://xu.renmaixifen.com/" target="_blank">NAS手气红包</a></li>
			<li><a class="text-muted" href="https://nasdrop.info/" target="_blank">星云空投</a></li>
			<li><a class="text-muted" href="http://nas.lubi.ren/" target="_blank">LuckyBlock</a></li>
			<li><a class="text-muted" href="http://sunnypickle.coding.me/nebulasgame/" target="_blank">星云修仙传</a></li>
			<li><a class="text-muted" href="http://nasweb.top/" target="_blank">2Dspace-Estate</a></li>
            </ul>
          </div>
        </div>
      </footer>
  </body>
</html>
